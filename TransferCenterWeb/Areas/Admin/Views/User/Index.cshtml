@model TransferCenterWeb.Areas.Admin.Models.UserViewModel
@using System.Linq
@using System.Text.Encodings.Web
@using TransferCenterWeb.Models.Shared

@{
    ViewBag.Title = "Users";
    Layout = "_Layout";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Users</h2>
    
</div>

@{
    var htmlEncoder = HtmlEncoder.Default;
    var rawSearch = ViewContext.HttpContext.Request.Query["search"].ToString();
    var encodedSearch = htmlEncoder.Encode(rawSearch ?? string.Empty);
    var currentPage = int.TryParse(ViewContext.HttpContext.Request.Query["page"], out var p) ? p : 1;
    var pageSize = int.TryParse(ViewContext.HttpContext.Request.Query["pageSize"], out var ps) ? ps : 10;
    if (pageSize <= 0)
    {
        pageSize = 10;
    }
    var total = Model?.TotalCount ?? 0;
    var totalPages = (int)System.Math.Ceiling(total / (double)pageSize);
    if (currentPage < 1)
    {
        currentPage = 1;
    }
    if (totalPages > 0 && currentPage > totalPages)
    {
        currentPage = totalPages;
    }
}

<div class="d-flex justify-content-between align-items-center mt-3">
    <div>
        Showing page @currentPage of @(totalPages > 0 ? totalPages : 1) â€” @total items
    </div>
    <div>
        @{
            var queryDictionary = ViewContext.HttpContext.Request.Query
                .ToDictionary(k => k.Key, v => v.Value.ToString(), System.StringComparer.OrdinalIgnoreCase);
            queryDictionary["pageSize"] = pageSize.ToString();
            var paginationModel = new PaginationModel
            {
                Action = nameof(TransferCenterWeb.Areas.Admin.Controllers.UserController.Index),
                Controller = "User",
                Area = "Admin",
                CurrentPage = currentPage,
                PageSize = pageSize,
                TotalItems = total,
                RouteValues = queryDictionary
            };
        }
        @await Html.PartialAsync("_Pagination", paginationModel)
    </div>
</div>

<form method="get" class="row g-2 mb-3">
    <div class="col-auto">
    <input type="text" name="search" class="form-control" placeholder="Search by name or email" value="@Html.Raw(encodedSearch)" />
    </div>
    <div class="col-auto">
        <select name="pageSize" class="form-select">
            <option value="10" @(pageSize == 10 ? "selected" : "")>10</option>
            <option value="25" @(pageSize == 25 ? "selected" : "")>25</option>
            <option value="50" @(pageSize == 50 ? "selected" : "")>50</option>
        </select>
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-secondary">Filter</button>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead class="table-light">
            <tr>
                <th scope="col">UserId</th>
                <th scope="col">FirstName</th>
                <th scope="col">LastName</th>
                <th scope="col">EmailId</th>
                <th scope="col">LoginId</th>
                <th scope="col">DomainID</th>
                <th scope="col">CreatedOn</th>
                <th scope="col" class="text-center">
                    <div class="btn-group" role="group" aria-label="Actions">
                        <a asp-area="Admin" asp-controller="User" asp-action="Create" class="btn btn-primary" title="Create New">
                            <i class="bi bi-plus-lg"></i>
                        </a>
                        <a asp-area="Admin" asp-controller="User" asp-action="ExportExcel" class="btn btn-success" title="Export to Excel">
                            <i class="bi bi-file-earmark-spreadsheet"></i>
                        </a>
                        <a asp-area="Admin" asp-controller="User" asp-action="ExportPdf" class="btn btn-danger" title="Export to PDF">
                            <i class="bi bi-file-earmark-pdf"></i>
                        </a>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Users != null && Model.Users.Any())
            {
                var idx = 1;
                foreach (var user in Model.Users)
                {
                    <tr>
                        <th scope="row">@idx</th>
                        <td>@user.FirstName</td>
                        <td>@user.LastName</td>
                        <td>@user.EmailId</td>
                        <td>@user.LoginId</td>
                        <td>@user.DomainID</td>
                        <td>@user.CreatedOn.ToString("yyyy-MM-dd")</td>
                        <td class="text-center">
                            <a asp-area="Admin" asp-controller="User" asp-action="Edit" asp-route-id="@user.UserId" class="btn btn-sm btn-outline-primary me-1" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <form asp-area="Admin" asp-controller="User" asp-action="Delete" asp-route-id="@user.UserId" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete" onclick="return confirm('Are you sure you want to delete this user?');">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    idx++;
                }
            }
            else
            {
                <tr>
                    <td colspan="8" class="text-center">No users found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>
