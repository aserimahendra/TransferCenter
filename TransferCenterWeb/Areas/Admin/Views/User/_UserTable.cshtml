@model TransferCenterWeb.Areas.Admin.Models.UserViewModel
@using System.Linq
@using System.Text.Encodings.Web
@using TransferCenterWeb.Models

@{
    var htmlEncoder = HtmlEncoder.Default;
    var rawSearch = ViewContext.HttpContext.Request.Query["search"].ToString();
    var encodedSearch = htmlEncoder.Encode(rawSearch ?? string.Empty);
    var currentPage = int.TryParse(ViewContext.HttpContext.Request.Query["page"], out var p) ? p : 1;
    var pageSize = int.TryParse(ViewContext.HttpContext.Request.Query["pageSize"], out var ps) ? ps : 10;
    if (pageSize <= 0)
    {
        pageSize = 10;
    }

    var total = Model?.TotalCount ?? 0;
    var totalPages = (int)System.Math.Ceiling(total / (double)pageSize);
    if (currentPage < 1)
    {
        currentPage = 1;
    }
    if (totalPages > 0 && currentPage > totalPages)
    {
        currentPage = totalPages;
    }

    var queryDictionary = ViewContext.HttpContext.Request.Query
        .ToDictionary(k => k.Key, v => v.Value.ToString(), System.StringComparer.OrdinalIgnoreCase);
    queryDictionary["pageSize"] = pageSize.ToString();

    var paginationModel = new PaginationModel
    {
        Action = nameof(TransferCenterWeb.Areas.Admin.Controllers.UserController.UserTable),
        Controller = "User",
        Area = "Admin",
        CurrentPage = currentPage,
        PageSize = pageSize,
        TotalItems = total,
        RouteValues = queryDictionary,
        RenderIfSinglePage = false
    };
}

<div class="d-flex justify-content-between align-items-center mt-3">
    <div>
        Showing page @currentPage of @(totalPages > 0 ? totalPages : 1) â€” @total items
    </div>
    <div>
        @await Html.PartialAsync("_Pagination", paginationModel)
    </div>
</div>

<form method="get" data-list-filter class="row g-2 mb-3">
    <div class="col-auto">
        <input type="text" name="search" class="form-control" placeholder="Search by name or email" value="@Html.Raw(encodedSearch)" />
    </div>
    <div class="col-auto">
        <select name="pageSize" class="form-select">
            <option value="10" @(pageSize == 10 ? "selected" : string.Empty)>10</option>
            <option value="25" @(pageSize == 25 ? "selected" : string.Empty)>25</option>
            <option value="50" @(pageSize == 50 ? "selected" : string.Empty)>50</option>
        </select>
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-secondary">Filter</button>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped table-bordered">
        <thead class="table-light">
            <tr>
                <th scope="col">User ID</th>
                <th scope="col">First Name</th>
                <th scope="col">Last Name</th>
                <th scope="col">Email</th>
                <th scope="col">Login ID</th>
                <th scope="col">Domain ID</th>
                <th scope="col">Created On</th>
                <th scope="col" class="text-center">
                    <div class="btn-group" role="group" aria-label="Actions">
                        <button type="button"
                                class="btn btn-primary"
                                data-modal-url="@Url.Action("Create", "User", new { area = "Admin" })"
                                data-modal-title="Create Admin User"
                                data-success-message="User created successfully."
                                title="Create New">
                            <i class="bi bi-plus-lg"></i>
                        </button>
                    </div>
                </th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Users != null && Model.Users.Any())
            {
                foreach (var user in Model.Users)
                {
                    <tr>
                        <th scope="row">@user.UserId</th>
                        <td>@user.FirstName</td>
                        <td>@user.LastName</td>
                        <td>@user.EmailId</td>
                        <td>@user.LoginId</td>
                        <td>@user.DomainID</td>
                        <td>@user.CreatedOn.ToString("yyyy-MM-dd")</td>
                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary me-1"
                                    data-modal-url="@Url.Action("Edit", "User", new { area = "Admin", id = user.UserId })"
                                    data-modal-title="Edit Admin User"
                                    data-success-message="User updated successfully."
                                    title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <form asp-area="Admin" asp-controller="User" asp-action="Delete" asp-route-id="@user.UserId" method="post" class="d-inline js-confirm-delete" data-confirm="Are you sure you want to delete this user?">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="8" class="text-center">No users found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>
