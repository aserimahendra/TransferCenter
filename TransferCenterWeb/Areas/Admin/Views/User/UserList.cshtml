@model TransferCenterWeb.Areas.Admin.Models.UserViewModel
@using System.Linq
@using System.Text.Encodings.Web
@using TransferCenterWeb.Models

@{
    var htmlEncoder = HtmlEncoder.Default;
    var rawSearch = ViewContext.HttpContext.Request.Query["search"].ToString();
    var encodedSearch = htmlEncoder.Encode(rawSearch ?? string.Empty);
    var currentPage = int.TryParse(ViewContext.HttpContext.Request.Query["page"], out var p) ? p : 1;
    var pageSize = int.TryParse(ViewContext.HttpContext.Request.Query["pageSize"], out var ps) ? ps : 10;
    if (pageSize <= 0)
    {
        pageSize = 10;
    }

    var total = Model?.TotalCount ?? 0;
    var totalPages = (int)System.Math.Ceiling(total / (double)pageSize);
    if (currentPage < 1)
    {
        currentPage = 1;
    }
    if (totalPages > 0 && currentPage > totalPages)
    {
        currentPage = totalPages;
    }

    var queryDictionary = ViewContext.HttpContext.Request.Query
        .ToDictionary(k => k.Key, v => v.Value.ToString(), System.StringComparer.OrdinalIgnoreCase);
    queryDictionary["pageSize"] = pageSize.ToString();

    var paginationModel = new PaginationModel
    {
        Action = nameof(TransferCenterWeb.Areas.Admin.Controllers.UserController.UserList),
        Controller = "User",
        Area = "Admin",
        CurrentPage = currentPage,
        PageSize = pageSize,
        TotalItems = total,
        RouteValues = queryDictionary,
        RenderIfSinglePage = false
    };
}

<div class="row align-items-center mb-3 g-2 mt-2">
    <div class="col d-flex align-items-center gap-2">
        <button type="button"
                class="btn btn-primary"
                data-modal-url="@Url.Action("Create", "User", new { area = "Admin" })"
                data-modal-title="Create Admin User"
                data-success-message="User created successfully."
                title="Create New">
            <i class="bi bi-plus-lg me-1"></i> Create
        </button>
    </div>
    <div class="col-auto ms-auto d-flex align-items-center gap-2">
        <form method="get" data-list-filter class="d-flex align-items-center gap-2 flex-nowrap mb-0">
            <label for="pageSize" class="col-form-label col-form-label-sm mb-0 me-2 text-muted text-nowrap">Page size</label>
            <select id="pageSize" name="pageSize" class="form-select form-select-sm" onchange="this.form.requestSubmit()">
                <option value="10" @(pageSize == 10 ? "selected" : string.Empty)>10</option>
                <option value="25" @(pageSize == 25 ? "selected" : string.Empty)>25</option>
                <option value="50" @(pageSize == 50 ? "selected" : string.Empty)>50</option>
            </select>
            <input type="hidden" name="search" value="@Html.Raw(encodedSearch)" />
        </form>
        <div>
            @await Html.PartialAsync("_Pagination", paginationModel)
        </div>
    </div>
</div>

<form method="get" data-list-filter class="row g-2 align-items-end mb-3">
    <div class="col-md-4">
        <label for="search" class="form-label">Search</label>
        <input id="search" type="text" name="search" class="form-control" placeholder="Search by name, email or login" value="@Html.Raw(encodedSearch)" />
    </div>
    <div class="col-md-8 d-flex gap-2 justify-content-end">
        <button type="button" class="btn btn-outline-secondary" onclick="(function(f){Array.from(f.elements).forEach(function(el){if(['submit','button','hidden'].includes(el.type))return; el.value='';}); f.requestSubmit();})(this.form)">Reset</button>
        <button type="submit" class="btn btn-secondary">Apply</button>
    </div>
</form>

<div class="table-responsive" data-user-list-root>
    @Html.AntiForgeryToken()
    <table class="table table-striped table-bordered">
        <thead class="table-light">
            <tr>
                <th scope="col">First Name</th>
                <th scope="col">Last Name</th>
                <th scope="col">Email</th>
                <th scope="col">Login ID</th>
                <th scope="col">Created On</th>
                <th scope="col" class="text-center">Active</th>
                <th scope="col" class="text-center">Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (Model != null && Model.Users != null && Model.Users.Any())
            {
                foreach (var user in Model.Users)
                {
                    <tr>
                        <td>@user.FirstName</td>
                        <td>@user.LastName</td>
                        <td>@user.EmailId</td>
                        <td>@user.LoginId</td>
                        <td>@user.CreatedOn.ToString("yyyy-MM-dd")</td>
                        <td class="text-center">
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input js-toggle-active" type="checkbox" role="switch"
                                       id="toggle-@user.UserId" data-user-id="@user.UserId" @(user.IsActive ? "checked" : "") />
                            </div>
                        </td>
                        <td class="text-center">
                            <button type="button"
                                    class="btn btn-sm btn-outline-primary me-1"
                                    data-modal-url="@Url.Action("Edit", "User", new { area = "Admin", id = user.UserId })"
                                    data-modal-title="Edit Admin User"
                                    data-success-message="User updated successfully."
                                    title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="7" class="text-center">No users found.</td>
                </tr>
            }
        </tbody>
    </table>
</div>
<div class="d-flex justify-content-end">
    <span class="small text-muted ms-2">Page @currentPage of @(totalPages > 0 ? totalPages : 1) â€” @total items</span>
</div>
