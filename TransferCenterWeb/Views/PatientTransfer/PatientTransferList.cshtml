@model TransferCenterWeb.Models.PatientTransfer.PatientTransferListViewModel
@using TransferCenterWeb.Models.PatientTransfer

@{
    var httpContext = ViewContext.HttpContext;

    var currentPage = int.TryParse(httpContext.Request.Query["page"], out var parsedPage) ? parsedPage : 1;
    if (currentPage < 1)
    {
        currentPage = 1;
    }

    var pageSize = int.TryParse(httpContext.Request.Query["pageSize"], out var parsedPageSize) ? parsedPageSize : 10;
    if (pageSize <= 0)
    {
        pageSize = 10;
    }

    var total = Model?.TotalCount ?? 0;
    var totalPages = (int)Math.Ceiling(total / (double)pageSize);
    if (totalPages > 0 && currentPage > totalPages)
    {
        currentPage = totalPages;
    }

    var queryDictionary = httpContext.Request.Query
        .ToDictionary(k => k.Key, v => v.Value.ToString(), StringComparer.OrdinalIgnoreCase);
    queryDictionary["pageSize"] = pageSize.ToString();

    var paginationModel = new PaginationModel
    {
        Action = nameof(TransferCenterWeb.Controllers.PatientTransferController.PatientTransferList),
        Controller = "PatientTransfer",
        CurrentPage = currentPage,
        PageSize = pageSize,
        TotalItems = total,
        RouteValues = queryDictionary,
        RenderIfSinglePage = false
    };

    var transfers = Model?.Items?
        .Select(x => x.PatientTransferInfo)
        .Where(x => x != null)
        .ToList() ?? new List<PatientTransferInfo>();
}

<div class="d-flex justify-content-between align-items-center mt-3">
    <div>
        Showing page @currentPage of @(totalPages > 0 ? totalPages : 1) â€” @total items
    </div>
    <div>
        @await Html.PartialAsync("_Pagination", paginationModel)
    </div>
</div>

<form method="get" data-list-filter class="row g-2 mb-3">
    <div class="col-auto">
        <select name="pageSize" class="form-select">
            <option value="10" selected="@(pageSize == 10 ? "selected" : null)">10</option>
            <option value="25" selected="@(pageSize == 25 ? "selected" : null)">25</option>
            <option value="50" selected="@(pageSize == 50 ? "selected" : null)">50</option>
        </select>
    </div>
    <div class="col-auto">
        <button type="submit" class="btn btn-secondary">Apply</button>
    </div>
</form>

<div class="d-flex justify-content-end align-items-center mb-3 gap-2">
    <button type="button" class="btn btn-primary" data-modal-url="@Url.Action("Create", "PatientTransfer")"
            data-modal-title="Create In-Patient Transfer Request"
            data-bs-toggle="tooltip" data-bs-placement="top" title="Create a new transfer request"
            aria-label="Add new transfer">
        <i class="bi bi-plus-circle"></i>
    </button>
    <a asp-controller="PatientTransfer" asp-action="ExportExcel" class="btn btn-success" title="Export to Excel"
       data-bs-toggle="tooltip" data-bs-placement="top" aria-label="Export to Excel">
        <i class="bi bi-file-earmark-spreadsheet"></i>
    </a>
</div>

<table class="table table-bordered table-striped">
    <thead class="table-primary">
    <tr>
    <th>Case Manager/SW/RN</th>
    <th>Transfer Date</th>
    <th>MR</th>
    <th>Primary Caller</th>
    <th>Phone Number</th>
    <th>Requesting Facility</th>
    <th>Admit Date</th>
    <th>Unit</th>
        <th>Action</th>
    </tr>
    </thead>
    <tbody>
    @if (transfers.Any())
    {
        foreach (var item in transfers)
        {
            <tr>
                <td>@Html.DisplayFor(_ => item.CaseMgrSwRn)</td>
                <td>@Html.DisplayFor(_ => item.TransferDate)</td>
                <td>@Html.DisplayFor(_ => item.MR)</td>
                <td>@Html.DisplayFor(_ => item.PrimaryCallerName)</td>
                <td>@Html.DisplayFor(_ => item.PhoneNumber)</td>
                <td>@Html.DisplayFor(_ => item.RequestingFacility)</td>
                <td>@Html.DisplayFor(_ => item.AdmitDate)</td>
                <td>@Html.DisplayFor(_ => item.Unit)</td>
                <td>
                    @{
                        var editUrl = Url.Action("Update", "PatientTransfer", new { id = item.UId });
                        var detailsUrl = Url.Action("Details", "PatientTransfer", new { id = item.UId });
                        var modalUpdateTitle = $"Update In-Patient transfer : {item.CaseMgrSwRn}";
                        var pdfTitle = $"Update In-Patient transfer : {item.CaseMgrSwRn}";
                        var modalDetailsTitle = $"In-Patient transfer Details:  {item.CaseMgrSwRn}";
                        var deleteUrl = Url.Action("Delete", "PatientTransfer", new { id = item.UId });
                        var pdfUrl = Url.Action("DetailsInPdf", "PatientTransfer", new { id = item.UId });
                        var modalDeleteTitle = $"Delete In-Patient transfer: {item.CaseMgrSwRn}";
                    }
                    <button type="button" class="btn btn-outline-secondary btn-sm me-1" data-modal-url="@editUrl"
                            data-modal-title="@modalUpdateTitle"
                            data-bs-toggle="tooltip" data-bs-placement="top" title="Edit this transfer"
                            aria-label="Edit transfer">
                        <i class="bi bi-pencil-square"></i>
                    </button>
                    <button type="button" class="btn btn-outline-primary btn-sm me-1" data-modal-url="@detailsUrl"
                            data-modal-title="@modalDetailsTitle"
                            data-bs-toggle="tooltip" data-bs-placement="top" title="View transfer details"
                            aria-label="View transfer details">
                        <i class="bi bi-info-circle"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" data-modal-url="@deleteUrl"
                            data-modal-title="@modalDeleteTitle"
                            data-bs-toggle="tooltip" data-bs-placement="top" title="Delete this transfer"
                            aria-label="Delete transfer">
                        <i class="bi bi-trash"></i>
                    </button>
                    <button type="button" class="btn btn-outline-danger btn-sm" data-download-url="@pdfUrl"
                      data-download-name="@($"PatientTransfer_{item.CaseMgrSwRn}.pdf")" onclick="(function(m,u,n){try{if(m&&typeof m.downloadFile==='function'){m.downloadFile(u,n);}else{var root=document.querySelector('[data-modal-list]');var id=root?root.getAttribute('data-loader-id'):null;var l=id?document.getElementById(id):null;if(l) l.classList.remove('d-none'); try{window.location.href=u;}finally{if(l) setTimeout(function(){l.classList.add('d-none');},2000);}}}catch(_e){window.location.href=u;}})(window.modalActions,'@pdfUrl','@($"PatientTransfer_{item.CaseMgrSwRn}.pdf")')"
                                data-bs-toggle="tooltip" data-bs-placement="top" title="Download PDF"
                                aria-label="Download PDF">
                            <i class="bi bi-file-earmark-pdf"></i>
                        </button>
                </td>
            </tr>
        }
    }
    else
    {
        <tr>
            <td colspan="9" class="text-center">No patient transfers found.</td>
        </tr>
    }
    </tbody>
</table>
